<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通知系統</title>
    <style>
        .notification-container {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 300px;
            background-color: #f9f9f9;
        }
        .notification-count {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .refresh-button {
            margin-top: 10px;
            padding: 5px 10px;
            font-size: 16px;
            cursor: pointer;
        }
        .notification-list-container {
            display: none; /* 初始隱藏 */
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: #fff;
        }
        .notification-item {
            margin-bottom: 10px;
            padding: 5px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }
        .notification-item.read {
            background-color: #f0f0f0; /* 已读通知背景色 */
        }
        .notification-date {
            font-size: 12px;
            color: #888;
        }
        .load-more-button {
            margin-top: 10px;
            padding: 5px 10px;
            font-size: 16px;
            cursor: pointer;
        }
        /* 新增的職位資訊樣式 */
        .job-list-container {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 600px;
            background-color: #f9f9f9;
        }
        .job-item {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
        }
        .job-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        .job-company {
            font-size: 16px;
            color: #555;
        }
        .job-desc {
            font-size: 14px;
            color: #333;
        }
        .job-link {
            display: inline-block;
            margin-top: 10px;
            padding: 5px 10px;
            font-size: 14px;
            color: #007bff;
            text-decoration: none;
        }
        .job-date, .job-source, .job-info {
            font-size: 12px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="notification-container">
        <div class="notification-count" id="notification-count">0</div>
        <button class="refresh-button" id="refresh-button">查看通知</button>
        <div class="notification-list-container" id="notification-list-container">
            <div class="notification-list" id="notification-list"></div>
            <button class="load-more-button" id="load-more-button">查看更多</button>
        </div>
    </div>
    <h3>Job SideBar</h3>
    <!-- 新增職位資訊部分 -->
    <div class="job-list-container" id="job-list-container">
        <div id="job-list"></div>
    </div>

    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/login.html';
            } else {
                const notificationCountElement = document.getElementById('notification-count');
                const notificationListElement = document.getElementById('notification-list');
                const notificationListContainer = document.getElementById('notification-list-container');
                const refreshButton = document.getElementById('refresh-button');
                const loadMoreButton = document.getElementById('load-more-button');

                let notifications = [];
                let displayedCount = 0;
                const limit = 5; // 每次顯示的數量

                const socket = io({
                    auth: {
                        token: token
                    }
                });

                function updateView(count) {
                    notificationCountElement.textContent = count;
                }

                function formatDate(dateString) {
                    const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                    return new Date(dateString).toLocaleDateString(undefined, options);
                }

                function displayNotifications() {
                    notificationListElement.innerHTML = '';
                    // const notificationsToDisplay = notifications.slice(0, displayedCount + limit);
                    const notificationsToDisplay = notifications
                        .slice(0, displayedCount + limit)
                        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    // console.log(notifications)
                    notificationsToDisplay.forEach(notification => {
                        const item = document.createElement('div');
                        item.className = 'notification-item' + (notification.isRead ? ' read' : '');
                        item.dataset.id = notification.notification_id;
                        
                        const text = document.createElement('div');
                        text.textContent = notification.text;
                        
                        const date = document.createElement('div');
                        date.className = 'notification-date';
                        date.textContent = formatDate(notification.createdAt);
                        
                        item.appendChild(text);
                        item.appendChild(date);
                        
                        item.addEventListener('click', () => {
                            openJobs(notification.notification_id) 
                            markAsRead(notification.notification_id);
                            item.classList.add('read');
                        });
                        
                        notificationListElement.appendChild(item);
                    });
                    loadMoreButton.style.display = notifications.length > displayedCount + limit ? 'block' : 'none';
                }

                function fetchNotifications() {
                    fetch('/notifications', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        notifications = data.notifications.details;
                        notifications.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        displayedCount = 0;
                        updateView(data.notifications.count);
                        displayNotifications();
                    })
                    .catch(error => console.error('獲取通知數量時發生錯誤:', error));
                }

                function openJobs(notificationId) {
                    // 查找通知對象
                    const notification = notifications.find(n => n.notification_id === notificationId);
                    // 如果有 link 屬性，根據 url 和 data 發送 API 請求
                    if (notification.link && notification.link.url) {
                        console.log("link");
                        const url = notification.link.url;
                        const data = notification.link.data || {};
                        console.log(url);
                        console.log(data);

                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({data})
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log(data); // 修正變數名
                            const jobListElement = document.getElementById('job-list');
                            jobListElement.innerHTML = '';

                            // Sort jobs by update_date
                            data.items.sort((a, b) => new Date(b.update_date) - new Date(a.update_date));

                            data.items.forEach(job => {
                                const jobItem = document.createElement('div');
                                jobItem.className = 'job-item';

                                // 職位標題作為鏈接
                                const link = document.createElement('a');
                                link.className = 'job-link';
                                link.href = job.job_link;
                                link.target = '_blank'; // 讓鏈接在新窗口打開

                                const title = document.createElement('div');
                                title.className = 'job-title';
                                title.textContent = job.job_title;

                                link.appendChild(title);

                                // 公司名稱
                                const company = document.createElement('div');
                                company.className = 'job-company';
                                company.textContent = job.company_name;

                                // 職位描述
                                const desc = document.createElement('div');
                                desc.className = 'job-desc';
                                const truncatedDesc = job.job_desc.length > 100 ? job.job_desc.substring(0, 100) + '...' : job.job_desc;
                                desc.textContent = truncatedDesc;

                                // 更新日期
                                const updateDate = document.createElement('div');
                                updateDate.className = 'job-date';
                                updateDate.textContent = `更新日期: ${formatDate(job.update_date)}`;

                                // 來源
                                const source = document.createElement('div');
                                source.className = 'job-source';
                                source.textContent = `來源: ${job.source}`;

                                // 職位資訊
                                const jobInfo = document.createElement('div');
                                jobInfo.className = 'job-info';
                                jobInfo.textContent = `職位資訊: ${job.job_info}`;

                                // 將所有內容加入 jobItem
                                jobItem.appendChild(link);
                                jobItem.appendChild(company);
                                jobItem.appendChild(desc);
                                jobItem.appendChild(updateDate);
                                jobItem.appendChild(source);
                                jobItem.appendChild(jobInfo);

                                // 將 jobItem 加入 jobListElement
                                jobListElement.appendChild(jobItem);
                            });
                        })
                        .catch(error => console.error('獲取職位資訊時發生錯誤:', error));
                    }
                }



                function markAsRead(notificationId) {
                    // 查找通知對象
                    const notification = notifications.find(n => n.notification_id === notificationId);

                    // 如果通知不存在或已讀，則不發起 API 請求
                    if (!notification || notification.isRead) {
                        return;
                    }

                    fetch(`/notifications/${notificationId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ isRead: true })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('通知已更新:', data);
                        // 更新本地通知列表中的状态
                        notification.isRead = true;
                    })
                    .catch(error => console.error('更新通知狀態時發生錯誤:', error));
                }

                refreshButton.addEventListener('click', () => {
                    console.log('Current display state:', notificationListContainer.style.display);
                    if (notificationListContainer.style.display === 'none' || notificationListContainer.style.display === '') {
                        notificationListContainer.style.display = 'block';
                        fetchNotifications();
                    } else {
                        notificationListContainer.style.display = 'none';
                    }
                });

                loadMoreButton.addEventListener('click', () => {
                    displayedCount += limit;
                    displayNotifications();
                });

                socket.on('connect', () => {
                    console.log('Socket.IO connected');
                });

                socket.on('connect_error', (err) => {
                    if (err.message === 'Authentication error') {
                        alert('認證錯誤，請重新登錄');
                        window.location.href = '/login.html';
                    } else {
                        console.error('Socket.io 連接錯誤:', err);
                    }
                });

                socket.on('notificationUpdate', (data) => {
                    console.log('Received notification update:', data);
                    updateView(data.count);
                    if (notificationListContainer.style.display === 'block') {
                        fetchNotifications(); // 獲取最新的通知
                    }
                });

                // 獲取通知數量
                function fetchNotificationCount() {
                    fetch('/notifications', {
                        headers: {
                            'Authorization': `Bearer ${token}` // 把 JWT 作為 Authorization header 傳遞
                        }
                    })
                    .then(response => response.json())
                    .then(data => updateView(data.count))
                    .catch(error => console.error('獲取通知數量時發生錯誤:', error));
                }

                // 初次加載時獲取通知數量
                fetchNotificationCount();
            }
        });
    </script>
</body>
</html>
